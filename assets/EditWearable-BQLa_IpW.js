import{c as b,r as a,j as e,d as ae,P as E,g as ne,h as _,i as j,B as y,C as ie,M as T,O as oe,Q as le,S as de,T as k,U as M,q as h,V as ce,W as ue,o as me,X as fe,Y as he,Z as xe,$ as pe,a0 as ge,a1 as ve,k as je,a2 as ye}from"./index-Dd9s-Wl6.js";import{E as C}from"./ElementTitleHeader-CTjdIz2E.js";import{u as we}from"./useWearable-DgL4RGHh.js";import{I as be,B as Ne,F as A}from"./Backdrop-De4BYmFo.js";import{$ as U}from"./module-j6hc5LO1.js";import{F as P}from"./FieldContainerInput-BrS7W6fW.js";import{H as w}from"./HorizontalDivider-DanKrOhN.js";import{W as Se}from"./WearableRefreshRate-DLoJLILn.js";import{g as ke,u as Ae}from"./storage--apS518Q.js";import{E as Ce}from"./eye-DktLUODS.js";import{P as Ee}from"./pencil-BSk8vZpQ.js";import{S as De}from"./share-2-CVjEeUpn.js";import"./react-DDCWQfk_.js";import"./react-dom-DZBigVa_.js";import"./alert-dialog-DusK-BE0.js";import"./input-Cxb16DK6.js";import"./index-DkU7GfEn.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=b("ChevronDown",[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=b("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=b("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=b("Trash",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=b("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);var D="Avatar",[_e,or]=ae(D),[Te,z]=_e(D),B=a.forwardRef((s,t)=>{const{__scopeAvatar:n,...c}=s,[o,d]=a.useState("idle");return e.jsx(Te,{scope:n,imageLoadingStatus:o,onImageLoadingStatusChange:d,children:e.jsx(E.span,{...c,ref:t})})});B.displayName=D;var V="AvatarImage",H=a.forwardRef((s,t)=>{const{__scopeAvatar:n,src:c,onLoadingStatusChange:o=()=>{},...d}=s,m=z(V,n),i=Ue(c,d.referrerPolicy),r=ne(l=>{o(l),m.onImageLoadingStatusChange(l)});return _(()=>{i!=="idle"&&r(i)},[i,r]),i==="loaded"?e.jsx(E.img,{...d,ref:t,src:c}):null});H.displayName=V;var $="AvatarFallback",W=a.forwardRef((s,t)=>{const{__scopeAvatar:n,delayMs:c,...o}=s,d=z($,n),[m,i]=a.useState(c===void 0);return a.useEffect(()=>{if(c!==void 0){const r=window.setTimeout(()=>i(!0),c);return()=>window.clearTimeout(r)}},[c]),m&&d.imageLoadingStatus!=="loaded"?e.jsx(E.span,{...o,ref:t}):null});W.displayName=$;function Ue(s,t){const[n,c]=a.useState("idle");return _(()=>{if(!s){c("error");return}let o=!0;const d=new window.Image,m=i=>()=>{o&&c(i)};return c("loading"),d.onload=m("loaded"),d.onerror=m("error"),d.src=s,t&&(d.referrerPolicy=t),()=>{o=!1}},[s,t]),n}var q=B,L=H,K=W;const O=a.forwardRef(({className:s,...t},n)=>e.jsx(q,{ref:n,className:j("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",s),...t}));O.displayName=q.displayName;const G=a.forwardRef(({className:s,...t},n)=>e.jsx(L,{ref:n,className:j("aspect-square h-full w-full",s),...t}));G.displayName=L.displayName;const Q=a.forwardRef(({className:s,...t},n)=>e.jsx(K,{ref:n,className:j("flex h-full w-full items-center justify-center rounded-full bg-muted",s),...t}));Q.displayName=K.displayName;const X=a.forwardRef(({className:s,...t},n)=>e.jsx("textarea",{className:j("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:n,...t}));X.displayName="Textarea";const ze=({value:s,onConfirm:t,onChange:n,placeholder:c,...o})=>{const{isEditing:d,setIsEditing:m}=a.useContext(be),i=a.useRef(null),[r,l]=a.useState(s??"");a.useEffect(()=>{l(s??""),i.current&&x()},[s]),a.useEffect(()=>{if(i.current){const p=parseFloat(getComputedStyle(i.current).lineHeight||"20");i.current.style.height=`${p*2}px`}},[]);const x=()=>{i.current&&(i.current.style.height="auto",i.current.style.height=`${i.current.scrollHeight}px`)},v=()=>{t?t(r).finally(()=>{m(!1)}):m(!1)},N=p=>{l(p.target.value),n&&n(p),x()};return e.jsxs(e.Fragment,{children:[d&&e.jsx(Ne,{onClose:v,open:d,confirm:s!==r}),e.jsx("div",{className:j("text-md flex items-center relative w-full",d?"rounded-md gap-2 z-[20] sm:max-w-md":"gap-4 max-w-xs"),onSubmit:p=>{p.preventDefault(),v()},children:e.jsxs("div",{className:"relative flex w-full",children:[e.jsx(X,{ref:i,value:r,onChange:N,placeholder:c,onFocusCapture:()=>m(!0),onBlur:()=>{m(!1),v()},className:j("w-full resize-none overflow-hidden min-h-3",d?"pr-10":""),...o}),d&&e.jsx(y,{onClick:v,type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 px-3 py-2 hover:bg-transparent",children:e.jsx(ie,{className:"h-4 w-4 horizontal-grow z-10",color:"white"})})]})})]})};async function Be(s){console.log("id",s);const t=await T.from("permissions_view").select().eq("device",s).order("created_at",{ascending:!1});return console.log("res",t),t}async function Ve(s,t){return await T.from("tracking_permissions").update({permission:t}).eq("id",s).select().returns()}function He(s){const[t,n]=a.useState([]),[c,o]=a.useState(!0),[d,m]=a.useState(0),i=a.useCallback(()=>{m(r=>r+1),console.log("forceUpdate")},[]);return a.useEffect(()=>{if(!s)return;(async()=>{o(!0);try{const l=await Be(s);l.error?(console.error("Error fetching permissions:",l.error),n([])):n(l.data)}catch(l){console.error("Unexpected error fetching permissions:",l),n([])}finally{o(!1)}})()},[s,d]),{permissions:t,loading:c,forceUpdate:i}}const $e=({permission:s,users:t,forceUpdate:n,loading:c})=>{const o=t.find(i=>i.id===s.user),d=async i=>{if(s.id)try{const r=await Ve(s.id,i);if(r.error)throw new Error(r.error.message);h.success("Permissão atualizada com sucesso"),n()}catch(r){console.error("Unexpected error updating permission:",r),h.error("Algo deu errado ao atualizar a permissão")}},m=()=>{switch(s.permission){case"viewer":return"Apenas ver";case"editor":return"Ver e editar";case"pending":return"Aguardando";case"blocked":return"Bloqueado"}};return e.jsxs("div",{className:"text-white flex justify-between items-center p-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-xl font-semibold line-clamp-1",children:o==null?void 0:o.name}),c?e.jsx("div",{className:"flex space-x-2",children:e.jsxs("div",{className:"bg-background border flex text-sm gap-1 rounded-full px-2 py-1 font-medium items-center text-muted",children:["Atualizando",e.jsx(U,{strokeColor:"white",width:"15"})]})}):e.jsxs("div",{className:"flex space-x-2",children:[(s.permission==="viewer"||s.permission==="editor")&&e.jsxs("div",{className:"bg-[#7AC74F] flex text-sm rounded-full pl-2 pr-1 py-1 font-medium items-center",children:["Visualizar",e.jsx(Ce,{className:"h-4"})]}),s.permission==="editor"&&e.jsxs("div",{className:"bg-[#FAA916] flex text-sm rounded-full pl-2 pr-1 py-1 font-medium items-center",children:["Modificar",e.jsx(Ee,{className:"h-3"})]}),s.permission==="pending"&&e.jsxs("div",{className:"bg-background border flex text-sm rounded-full pl-2 pr-1 py-1 font-medium items-center",children:["Pendente",e.jsx(Re,{className:"h-3"})]})]})]}),e.jsx("div",{children:e.jsxs(oe,{children:[e.jsx(le,{children:e.jsxs(y,{variant:s.permission==="pending"?"default":"secondary",className:j(s.permission==="pending"?"text-primary bg-white":""),size:"sm",children:[m()," ",e.jsx(Fe,{})]})}),e.jsxs(de,{side:"bottom",children:[e.jsx(k,{onClick:()=>{d("editor")},children:"Ver e editar"}),e.jsx(k,{onClick:()=>{d("viewer")},children:"Apenas ver"}),e.jsx(M,{}),e.jsx(k,{onClick:()=>{d("pending")},children:"Remover permissão"}),e.jsx(M,{}),e.jsx(k,{onClick:()=>{d("blocked")},children:"Bloquear"})]})]})})]})},We=({id:s})=>{const{permissions:t,loading:n,forceUpdate:c}=He(s),[o,d]=a.useState([]),m=a.useMemo(()=>t.filter(l=>l.permission!=="blocked"),[t]),i=a.useMemo(()=>{const l=[];for(const x of m)x.user&&l.push(x.user);return l},[m]),r=async()=>{try{const l=await ce(i);if(l.error)throw new Error(l.error.message);console.log("Users fetched:",l),d(l.data)}catch(l){console.log("Unexpected error fetching users:",l),h.error("Algo deu errado ao buscar os usuários")}};return a.useEffect(()=>{i.length&&r()},[i]),e.jsx("div",{children:e.jsxs("ul",{children:[m.map(l=>e.jsxs("li",{children:[e.jsx(w,{className:"border-white my-0"}),e.jsx($e,{permission:l,users:o,forceUpdate:c,loading:n})]},l.user)),e.jsxs("li",{children:[e.jsx(w,{className:"border-white my-0"}),e.jsx("div",{className:"flex justify-center p-4 ",children:e.jsx(y,{variant:"secondary",disabled:n,children:n?"Carregando...":e.jsxs(e.Fragment,{children:["Compartilhar com outro usuário ",e.jsx(De,{})]})})})]})]})})},lr=()=>{var I;const{id:s}=ue(),t=a.useRef(null),[n,c]=a.useState(!1),{wearable:o,loading:d}=we(s),[m,i]=a.useState(null),[r,l]=a.useState(void 0),[x,v]=a.useState(void 0),[N,p]=a.useState(void 0),[F,R]=a.useState(),Y=me();if(a.useEffect(()=>{o&&(l(o),v(o.birthday?new Date(o.birthday).toLocaleDateString("pt-BR"):void 0),o.avatar_url&&i(ke(o.avatar_url).data.publicUrl),o.refresh_delay&&p(o.refresh_delay))},[o]),d)return e.jsx("div",{children:"Carregando..."});if(!o)return e.jsx("div",{className:"text-white",children:"Pulseira não encontrado"});const Z=async f=>{l(u=>u&&{...u,name:f})},J=()=>{var f;(f=t.current)==null||f.click()},ee=f=>{var g;const u=(g=f.target.files)==null?void 0:g[0];if(R(u),u){const S=new FileReader;S.onload=()=>{const te=S.result;i(te)},S.onerror=()=>{h.error("Erro ao carregar foto de perfil.")},S.readAsDataURL(u)}},re=()=>{i(null),R(void 0),h.info("Foto de perfil removida.")},se=async()=>{if(!r)return;if(!x){h.error("Data de nascimento inválida.");return}if(!r.name){h.error("Nome inválido.");return}if(!r.id){h.error("ID inválido.");return}if(!N){h.error("Taxa de atualização inválida.");return}c(!0);let f=null;try{if(F){const{data:u,error:g}=await Ae(r.id,F);if(g)throw g;u&&(f=u.path)}try{const u={name:r.name,birthday:new Date(x).toISOString(),other_info:r.other_info,refresh_delay:N};f&&(u.avatar_url=f);const{error:g}=await ye(r.id,u);if(g)throw g;h.success("Dados salvos com sucesso."),Y(`/dashboard/wearable/${r.id}`)}catch(u){console.error(u),h.error("Erro ao salvar dados.")}}catch(u){console.error(u),h.error("Erro ao salvar foto de perfil.")}c(!1)};return e.jsxs("div",{className:"space-y-3 text-white",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx(C,{className:"text-white",title:r!=null&&r.name?r==null?void 0:r.name:"Sem nome"}),e.jsxs(O,{className:"h-36 w-36 mt-6 mb-3 border-2 border-white shadow-md",children:[e.jsx(G,{src:m||void 0,className:"object-cover "}),e.jsx(Q,{className:"text-white text-7xl font-semibold bg-white/10",children:(I=fe(r!=null&&r.name?r==null?void 0:r.name:"Sem nome"))==null?void 0:I.slice(0,2)})]}),e.jsxs(he,{children:[e.jsx(xe,{onClick:()=>{navigator.clipboard.writeText((r==null?void 0:r.id)??""),h.success("Endereço MAC copiado para a área de transferência")},children:e.jsx("div",{className:"flex items-center justify-center border rounded-md px-2 text-white ",children:r==null?void 0:r.id})}),e.jsxs(pe,{side:"bottom",children:[e.jsx("p",{children:"Endereço MAC"}),e.jsx(ge,{className:"stroke-white fill-white"})]})]})]}),e.jsx(w,{className:"my-7"}),e.jsx(A,{title:"Nome",children:e.jsx(P,{value:(r==null?void 0:r.name)??"Sem Nome",onChange:f=>Z(f.target.value),type:"text",placeholder:"Fulano da Silva"})}),e.jsx(A,{title:"Data de Nascimento",children:e.jsx(P,{value:x,placeholder:"Dia/Mês/Ano",onChange:f=>{const u=ve(f.target.value);v(u)},type:"text",inputMode:"numeric",pattern:"\\d*",maxLength:10})}),e.jsxs(A,{title:"Foto de Perfil",children:[e.jsx("input",{type:"file",accept:"image/*",style:{display:"none"},onChange:ee,ref:t}),m?e.jsxs(y,{variant:"secondary",size:"sm",onClick:re,children:["Remover Foto",e.jsx(Me,{})]}):e.jsxs(y,{variant:"secondary",size:"sm",onClick:J,children:["Enviar Foto",e.jsx(Pe,{})]})]}),e.jsx(A,{title:"Informações Adicionais",children:e.jsx(ze,{placeholder:"Informações sobre dificuldades físicas.",value:(r==null?void 0:r.other_info)??"",onChange:f=>{l(u=>u&&{...u,other_info:f.target.value})}})}),e.jsx(w,{className:"mt-8"}),e.jsx(C,{title:"Configuração da pulseira",description:"Defina as configurações da pulseira."}),e.jsx(je,{title:"Taxa de atualização",titleBackground:!0,border:!0,children:e.jsx("div",{className:"px-6 py-4 text-white",children:e.jsx(Se,{defaultValue:(r==null?void 0:r.refresh_delay)||void 0,onChangeComplete:f=>{p(f)}})})}),e.jsx(w,{className:"mt-8"}),e.jsx(C,{title:"Compartilhamento",description:"Aqui estão as pessoas com quem você compartilhou esta pulseira."}),e.jsx(We,{id:o.id}),e.jsx("div",{className:"flex justify-end pt-2",children:e.jsx(y,{className:"bg-white text-primary",onClick:se,disabled:n,children:n?e.jsxs(e.Fragment,{children:["Atualizando ",e.jsx(U,{strokeColor:"#4b33be"})]}):e.jsxs(e.Fragment,{children:["Salvar ",e.jsx(Ie,{})]})})})]})};export{lr as default};
